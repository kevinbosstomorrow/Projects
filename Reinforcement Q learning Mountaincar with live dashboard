
import matplotlib.pyplot as plt
import pandas as pd
import numpy as np
import gym
import streamlit as st
import plotly.express as px # interactive charts 
import itertools
env =gym.make('MountainCar-v0')
env.reset()


num_states = (env.observation_space.high - env.observation_space.low) * np.array([10, 100])
num_states = np.round(num_states, 0).astype(int)

# Q table 
Q = np.zeros([num_states[0], num_states[1],env.action_space.n])


#learning rate
lr = 1

discount = 1  

episodes = 25000


st.set_page_config(
    page_title = 'Real-Time Mountain car Dashboard',
    page_icon = 'âœ…',
    layout = 'wide'
)

def get_discrete_states(x):
    s = (x - env.observation_space.low) * np.array([10, 100])
    s = np.round(s, 0).astype(int)
    s = tuple(s)
    return s


#'''åŠ å…¥æ¢ç´¢éƒ¨åˆ†'''
# Exploration settings

rewards = []
rewards_dict = {'episodes' : [], 'avg': [], 'min':[], 'max':[], 'success':[]}



placeholder = st.empty()

env._max_episode_steps = 400
success = 0

for e in range(episodes):

        
    episode_reward = 0

    done = False
    s = env.reset()
    state = get_discrete_states(s)    
    
    while not done:
        
        action = np.argmax(Q[state])
            
        ns, reward, done, _ = env.step(action)  
        new_state = get_discrete_states(ns)
        
        episode_reward += reward
        #d.append(done)
        
        
        if e % 100 == 0:
            env.render()
        
        
        # Q learning 
        if done == False:
            nextq = np.max(Q[new_state])
            currentq = Q[state][action]
            
            # temporal difference 
            td = reward + discount*nextq - currentq
            
            Q[state][action] =  Q[state][action] + lr*td
    
    
        # position 
        elif ns[0] > env.goal_position:
            Q[state][action] = 1 
            success += 1
            print(f'we made on episode {e}')
            
            
        state = new_state
    env.close()
    
    rewards.append(episode_reward)
    average_reward = np.mean(rewards)
    rewards_dict['episodes'].append(e)
    rewards_dict['avg'].append(average_reward)
    rewards_dict['max'].append(max(rewards))
    rewards_dict['min'].append(min(rewards))
    rewards_dict['success'].append(success)    

    with placeholder.container():
        #st.title('Simple Reinforcement learning(ç®€å•çš„ä¸€ä¸ªå¼ºåŒ–å­¦ä¹ æ¼”ç¤º)ğŸ˜›')
        #st.markdown(<div style="text-align: center"> 'Simple Reinforcement learning(ç®€å•çš„ä¸€ä¸ªå¼ºåŒ–å­¦ä¹ æ¼”ç¤º)ğŸ˜›' </div>)
        #st.markdown("<h1 style='text-align: center; color: black;'>Simple Reinforcement learning(ç®€å•çš„ä¸€ä¸ªå¼ºåŒ–å­¦ä¹ æ¼”ç¤º)ğŸ˜›</h1>", unsafe_allow_html=True)
        
        c1, c2, c3 = st.columns(3)
        with c1:
            st.subheader("Live-dashboard(æ—¶æ—¶è·Ÿæ–°å°è½¦å­¦ä¹ çŠ¶æ€)")
        with c2:
            st.subheader('Current episode(è®­ç»ƒæ¬¡æ•°): ' +  str(e) + 'ğŸ‘ˆ')
        with c3:
            if ns[0] > env.goal_position:
                st.subheader('Number of time success(æˆåŠŸæ¬¡æ•°): ' +  str(success) + 'ğŸ‘')
        
    
        # åˆ›å»ºQ table 
        #st.markdown("### Live Q table data(æ—¶æ—¶è·Ÿæ–°å°è½¦çš„æ¯ä¸€ä¸ªçŠ¶æ€)")
        
        t1, t2, t3, t4, t5 ,t6, t7 = st.columns(7)
        with t1:
            st.write('çŠ¶æ€1')
            st.dataframe(pd.DataFrame(Q[0].astype('int'), columns= ['Left','Stop','Right']).style.highlight_max(color = 'lightgreen', axis=1))
        with t2:
            st.write('çŠ¶æ€2')
            st.dataframe(pd.DataFrame(Q[5].astype('int'), columns= ['Left','Stop','Right']).style.highlight_max(color = 'lightgreen', axis=1))
        with t3:
            st.write('çŠ¶æ€3')
            st.dataframe(pd.DataFrame(Q[8].astype('int'), columns= ['Left','Stop','Right']).style.highlight_max(color = 'lightgreen', axis=1))
        with t4:
            st.write('çŠ¶æ€4')
            st.dataframe(pd.DataFrame(Q[10].astype('int'), columns= ['Left','Stop','Right']).style.highlight_max(color = 'lightgreen', axis=1))
        with t5:
            st.write('çŠ¶æ€5')
            st.dataframe(pd.DataFrame(Q[12].astype('int'), columns= ['Left','Stop','Right']).style.highlight_max(color = 'lightgreen', axis=1))
        with t6:
            st.write('çŠ¶æ€6')
            st.dataframe(pd.DataFrame(Q[14].astype('int'), columns= ['Left','Stop','Right']).style.highlight_max(color = 'lightgreen', axis=1))
        with t7:
            st.write('çŠ¶æ€7')
            st.dataframe(pd.DataFrame(Q[16].astype('int'), columns= ['Left','Stop','Right']).style.highlight_max(color = 'lightgreen', axis=1))
        

        f1, f2, f3 = st.columns(3)
        with f1:
            #st.write("Max Reward Map(æœ€å¤§å¥–åŠ±)ğŸš€")
            fig = px.line(x = rewards_dict['episodes'], y = rewards_dict['max'])
            fig.update_layout(title_text="Max Reward Map(æœ€å¤§å¥–åŠ±)",title_y= 0.5,title_x=0.5, font=dict(size=20,color="black" ),xaxis_title="è®­ç»ƒæ•°",yaxis_title="æœ€å¤§å¥–åŠ±")
            st.write(fig)
            #st.write("Max Reward Map(æœ€å¤§å¥–åŠ±)ğŸš€")
        with f2:
            #st.subheader("Avg Reward Map(å¹³å‡å¥–åŠ±)ğŸš€")
            fig = px.line(x = rewards_dict['episodes'], y = rewards_dict['avg'])
            fig.update_layout(title_text="Avg Reward Map(å¹³å‡å¥–åŠ±)",title_y= 0.5,title_x=0.5, font=dict(size=20,color="black" ),xaxis_title="è®­ç»ƒæ•°",yaxis_title="å¹³å‡å¥–åŠ±")
            st.write(fig)
        with f3:
            #st.subheader("Total vs Scuccess(è®­ç»ƒæ•°vsæˆåŠŸæ•°)ğŸš€")
            fig = px.line(x = rewards_dict['episodes'], y = rewards_dict['success'])
            fig.update_layout(title_text="Total vs Scuccess(è®­ç»ƒæ•°vsæˆåŠŸæ•°)ğŸš€",title_y= 0.5,title_x=0.5, font=dict(size=20,color="black" ),xaxis_title="è®­ç»ƒæ•°",yaxis_title="æˆåŠŸæ•°")
            st.write(fig)





fig = plt.figure(figsize=(12, 9))
ax1 = fig.add_subplot(311)
for x, x_vals in enumerate(Q):
    #print(x_vals)
    for y, y_vals in enumerate(x_vals):
        #print(y)    
        ax1.scatter(x, y)



fig = plt.figure(figsize=(12, 9))
plt.figure(figsize=(12, 9)).scatter(x, y)
 

Qdf = pd.DataFrame()
for n in range(Q.shape[0]):
    qdf = pd.DataFrame(Q[n])
    Qdf = pd.concat([Qdf,qdf])



s1 = np.arange(-12,6)
s2 = np.arange(-7,7,)

#states list
sl = []
for r in itertools.product(s1, s2): 
    sl.append((r[0], r[1]))
    
qdf = pd.DataFrame()
Qdf['state1 & 2'] = sl







